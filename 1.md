# ShotBoard v0.1 MVP 規格書

## 產品定位

**一句話描述**：截圖 → 貼到白板 → 加註記 → 開鏡頭泡泡 → 一鍵錄影輸出

**目標用戶**：需要快速產出教學、解說、回饋影片的創作者

**核心價值**：把「截圖標註 + 人像錄影」的流程壓縮到一個工具內完成

---

## 技術架構

```
┌─────────────────────────────────────────────────────┐
│                    Electron App                      │
├─────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  Screenshot │  │  Whiteboard │  │  Recorder   │  │
│  │   Module    │  │   Engine    │  │   Module    │  │
│  │             │  │             │  │             │  │
│  │ electron-   │  │ Excalidraw  │  │ Canvas      │  │
│  │ capture     │  │ (MIT)       │  │ Compositor  │  │
│  │ desktopCap- │  │             │  │ MediaRec-   │  │
│  │ turer API   │  │             │  │ order       │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
├─────────────────────────────────────────────────────┤
│                 React + TypeScript                   │
└─────────────────────────────────────────────────────┘
```

### 技術選型

| 層級 | 選擇 | 原因 |
|------|------|------|
| 桌面框架 | Electron | 全螢幕截圖、跨應用取畫面、快捷鍵、檔案存取 |
| 前端框架 | React + TypeScript | 生態成熟、型別安全 |
| 白板引擎 | Excalidraw (MIT) | 授權自由、嵌入容易、社群活躍 |
| 截圖 | electron-capture + desktopCapturer | 框選、overlay、輸出 blob |
| 錄影 | Canvas compositor + MediaRecorder | 快速、跨平台、不依賴 ffmpeg |

---

## 核心功能規格

### 1. 白板模組 (Whiteboard)

**必要功能**
- 無限畫布（平移 / 縮放）
- 貼上圖片（來自截圖或拖拉檔案）
- 文字工具（MVP 只做單一字體、2-3 種大小）
- 選取、移動、縮放、刪除物件
- 專案存檔 / 開檔

**資料格式**
```typescript
interface Project {
  schemaVersion: string;
  canvas: {
    viewportX: number;
    viewportY: number;
    zoom: number;
  };
  nodes: Node[];
  assets: Record<string, string>; // assetId -> filePath
}

interface Node {
  id: string;
  type: 'image' | 'text';
  x: number;
  y: number;
  width: number;
  height: number;
  rotation: number;
  // type-specific
  assetRef?: string;  // for image
  content?: string;   // for text
  fontSize?: number;  // for text
}
```

### 2. 截圖模組 (Screenshot)

**必要功能**
- 框選截圖
- 全螢幕截圖
- 截圖後自動插入白板中心

**快捷鍵**
| 動作 | 快捷鍵 |
|------|--------|
| 框選截圖 | `Ctrl+Shift+2` |
| 全螢幕截圖 | `Ctrl+Shift+3` |

**流程**
```
按快捷鍵 → 顯示 overlay → 框選區域 → 擷取像素 → 
存成 PNG → 插入白板中心 → 自動選取該圖片
```

### 3. 錄影模組 (Recorder)

**必要功能**
- 錄製白板內容（Canvas 合成方式，非螢幕錄製）
- 錄鏡頭（可開關）
- 鏡頭泡泡：右下角預設、圓形遮罩、可拖曳、可調大小
- 麥克風收音
- 錄影計時器顯示（格式：MM:SS）
- 匯出 WebM

**合成架構**
```
┌────────────────────────────────────────┐
│            Compositor Canvas           │
│  ┌──────────────────────────────────┐  │
│  │                                  │  │
│  │      白板畫面 (主畫面)            │  │
│  │                                  │  │
│  │                         ┌─────┐  │  │
│  │                         │ 📷 │  │  │
│  │                         │泡泡 │  │  │
│  │                         └─────┘  │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
         ↓ canvas.captureStream()
         ↓ + 麥克風 audio track
         ↓ MediaRecorder
         ↓
      output.webm
```

**鏡頭泡泡規格**
- 預設位置：右下角，距邊緣 20px
- 預設尺寸：120px 直徑
- 可拖曳到任意位置（滑鼠拖曳移動）
- 可調整大小：80px ~ 200px（透過滑鼠滾輪或拖曳控制點）
- 圓形遮罩（clip-path 或 canvas arc clip）
- 攝影機預覽與錄影分離：預覽使用 HTML video 元素，錄影時用 Canvas 合成

**錄影計時器規格**
- 顯示格式：MM:SS（分:秒）
- 位置：錄影按鈕旁或畫面左上角
- 僅在錄影進行中顯示
- 每秒更新一次

---

## 檔案結構

```
shotboard/
├── package.json
├── electron/
│   ├── main.ts              # Electron 主進程
│   ├── preload.ts           # preload script
│   └── screenshot.ts        # 截圖邏輯
├── src/
│   ├── App.tsx
│   ├── components/
│   │   ├── Whiteboard/
│   │   │   ├── index.tsx
│   │   │   └── useWhiteboard.ts
│   │   ├── Screenshot/
│   │   │   └── ScreenshotOverlay.tsx
│   │   ├── Recorder/
│   │   │   ├── index.tsx
│   │   │   ├── CameraBubble.tsx
│   │   │   └── useRecorder.ts
│   │   └── Toolbar/
│   │       └── index.tsx
│   ├── stores/
│   │   └── projectStore.ts  # Zustand 狀態管理
│   ├── utils/
│   │   ├── compositor.ts    # Canvas 合成邏輯
│   │   └── fileSystem.ts    # 檔案讀寫
│   └── types/
│       └── project.ts       # TypeScript 型別
├── projects/                 # 使用者專案存放
│   └── [project-name]/
│       ├── project.json
│       ├── assets/
│       │   └── *.png
│       └── recordings/
│           └── *.webm
```

---

## 開發任務清單

### P0 - 必須完成 (MVP 核心)

- [x] **專案初始化** ✅ 2024-12-26
  - [x] Electron + React + TypeScript 腳手架
  - [x] 基本視窗配置

- [x] **白板基礎** ✅ 2024-12-26
  - [x] 嵌入 Excalidraw
  - [x] 圖片插入功能
  - [x] 文字工具 (Excalidraw 內建)

- [x] **截圖功能** ✅ 2024-12-26
  - [x] desktopCapturer 取得螢幕
  - [x] 框選 overlay UI
  - [x] 擷取並插入白板

- [x] **錄影功能** ✅ 2024-12-26
  - [x] 取得鏡頭 stream
  - [x] Canvas compositor 合成 (30fps)
  - [x] MediaRecorder 輸出 WebM

- [x] **檔案系統** ✅ 2024-12-26 (基礎 IPC 已實作)
  - [x] 專案存檔 (JSON + assets)
  - [x] 專案開檔

### P1 - 加分項 (MVP 後)

- [ ] 快捷鍵系統完善
- [x] 鏡頭泡泡拖曳 / 調整大小 ✅ 已納入 MVP
- [x] 錄影時間顯示 ✅ 已納入 MVP
- [ ] 系統音訊收錄
- [ ] 匯出 MP4 (ffmpeg)
- [ ] 多個鏡頭切換

### P2 - 未來擴充

- [ ] 筆刷 / 手寫
- [ ] 版本回朔 / 時間軸
- [ ] 雲端同步
- [ ] 多人協作

---

## 驗收清單

完成以下項目即視為 MVP 過關：

- [ ] 快捷鍵框選截圖成功，能貼到白板
- [ ] 圖片可拖曳、縮放、刪除
- [ ] 文字框可新增、編輯、移動
- [ ] 開鏡頭後右下角圓形泡泡出現
- [ ] 錄影開始 / 停止可用，輸出 WebM 可播放
- [ ] 專案能存檔 / 開檔

---

## 明確不做 (避免 scope creep)

| 功能 | 原因 |
|------|------|
| 多人協作 | 複雜度過高 |
| 版本回朔 / 時間軸 | MVP 不需要 |
| 筆刷 / 手寫 | 截圖 + 文字已足夠 |
| 多軌剪輯、字幕、特效 | 非核心功能 |
| 匯出 MP4 | 避免導入 ffmpeg 的複雜度 |

---

## 已知問題與修正

### 1. 文字功能的字體載入問題

**問題描述**：Excalidraw 使用自定義字體（Virgil, Cascadia 等），需要正確載入字體檔案才能正常顯示。

**解決方案**：
- 在 `index.html` 中使用 `<link rel="preload">` 預載入字體
- 確保字體檔案放在 `public/fonts/` 目錄
- 使用 `@font-face` 宣告字體，搭配正確的 `font-display: swap`

**相關檔案**：
- `public/index.html`
- `public/fonts/`

### 2. 攝影機預覽與錄影分離

**問題描述**：攝影機泡泡的預覽畫面和實際錄影需要分離處理，避免互相干擾。

**解決方案**：
- 預覽：使用 HTML `<video>` 元素直接顯示攝影機串流
- 錄影：使用 Canvas 合成，將白板內容與攝影機畫面合併
- 兩者使用同一個 `MediaStream`，但渲染方式不同

**架構**：
```
攝影機 MediaStream
    ├── video element (預覽顯示)
    └── Canvas compositor (錄影合成)
```

### 3. 錄影應使用 Canvas 合成而非螢幕錄製

**問題描述**：原本設計使用螢幕錄製會導致錄到 UI 元素（工具列、按鈕等）。

**解決方案**：
- 使用 Canvas 合成方式錄製
- 主要錄製 Excalidraw 的白板內容（透過 `exportToCanvas()` API）
- 將攝影機畫面以圓形遮罩方式合成到指定位置
- 使用 `canvas.captureStream()` 取得串流供 MediaRecorder 使用

**優點**：
- 只錄製白板內容，不包含 UI 元素
- 可自訂錄製解析度
- 攝影機泡泡位置可在錄影中動態調整

**相關檔案**：
- `src/utils/compositor.ts`
- `src/components/Recorder/useRecorder.ts`

---

## 授權備註

| 套件 | 授權 | 備註 |
|------|------|------|
| Excalidraw | MIT | ✅ 商用自由 |
| electron-capture | MIT | ✅ 商用自由 |
| WBO | AGPL-3.0 | ⚠️ 不建議使用，感染型授權 |
| tldraw | source-available | ⚠️ 有水印與商用限制 |

---

## 快速開始指令

```bash
# 建立專案
npx create-electron-app shotboard --template=webpack-typescript

# 安裝核心依賴
npm install react react-dom @excalidraw/excalidraw zustand

# 開發
npm run start

# 打包
npm run make
```

幾個開發建議：

先不要自己做白板 — Excalidraw 已經把拖拉、縮放、選取都處理好了，直接嵌入省一大堆工。重點放在「截圖 → 插入」和「錄影合成」這兩塊。
錄影合成是這個專案最 tricky 的地方 — Canvas compositor 每幀要 draw 兩個來源（白板 + 鏡頭），效能要顧。建議用 requestAnimationFrame 控制幀率，MVP 先鎖 30fps。
Excalidraw 嵌入有坑 — 它的 @excalidraw/excalidraw package 預設樣式會吃掉整個 viewport，你需要自己處理 container 的尺寸控制。
截圖的 overlay 建議開新 BrowserWindow — 用透明的 frameless window 做框選 UI，比在主視窗裡搞 z-index 乾淨很多。

開發順序建議：

先把 Electron + Excalidraw 跑起來
做截圖 → 插入白板
做鏡頭 + 合成 + MediaRecorder
最後補存檔 / 開檔