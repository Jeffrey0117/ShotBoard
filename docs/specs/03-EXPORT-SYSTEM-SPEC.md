# 03 - 靜態網頁/PDF 導出模組技術規格

> **模組名稱**: Export System (GitSite-like)
> **版本**: 1.0.0
> **最後更新**: 2025-01-XX
> **狀態**: Draft

---

## 1. 模組概述

### 1.1 功能目標

Export System 是 ShotBoard 內容創作平台的核心導出模組，負責將 Markdown 筆記、白板繪圖、簡報內容轉換為可分享的靜態格式。本模組的設計理念類似於 GitSite、VuePress 等靜態網站生成器，但更專注於與 ShotBoard 生態系統的深度整合。

### 1.2 核心能力

| 能力 | 描述 |
|------|------|
| **HTML 單頁導出** | 將單一筆記導出為自包含的 HTML 文件 |
| **多頁靜態網站** | 將整個筆記資料夾導出為完整靜態網站 |
| **PDF 文檔生成** | 高品質 PDF 導出，支援列印與分享 |
| **簡報獨立導出** | 將 Slidev 風格簡報導出為可離線播放的 HTML |
| **資源打包** | 自動處理圖片、白板、影片等嵌入資源 |
| **主題模板系統** | 可自訂的導出樣式與版面配置 |

### 1.3 範圍界定

**包含 (In Scope)**:
- 本地檔案系統導出
- 內建模板系統
- 資源最佳化與打包
- Electron 環境下的 PDF 生成
- 導出預覽功能

**不包含 (Out of Scope)**:
- 雲端發佈 (如 GitHub Pages 自動部署)
- 即時協作導出
- 影片轉碼功能
- 第三方 CMS 整合

---

## 2. 用戶故事 (User Stories)

### US-001: 單頁 HTML 導出
> **作為** 一位技術文件撰寫者
> **我希望** 能將單一 Markdown 筆記導出為自包含的 HTML 文件
> **以便** 透過電子郵件分享給同事，無需額外伺服器

**驗收條件**:
- 導出的 HTML 文件包含所有 CSS 樣式 (inline)
- 嵌入的圖片轉換為 Base64 或相對路徑
- 白板繪圖以 SVG 格式嵌入
- 程式碼區塊具有語法高亮
- 文件可在主流瀏覽器離線開啟

---

### US-002: 多頁靜態網站生成
> **作為** 一位線上課程製作者
> **我希望** 能將整個課程資料夾導出為靜態網站
> **以便** 部署到任意靜態網站託管服務

**驗收條件**:
- 自動生成導覽選單與側邊欄
- 保留原始資料夾結構
- 生成 index.html 首頁
- 支援相對路徑，可部署至子目錄
- 包含搜索功能 (client-side)

---

### US-003: PDF 文檔導出
> **作為** 一位企業培訓講師
> **我希望** 能將培訓手冊導出為 PDF 格式
> **以便** 列印發放給學員或提供正式文檔

**驗收條件**:
- 支援 A4/Letter 等常見紙張尺寸
- 自動分頁，避免內容截斷
- 可選擇是否包含目錄頁
- 支援頁首/頁尾自訂 (頁碼、標題、日期)
- 白板與圖片以高解析度嵌入

---

### US-004: 簡報獨立導出
> **作為** 一位會議簡報者
> **我希望** 能將簡報導出為可離線播放的 HTML
> **以便** 在無網路環境下進行演示

**驗收條件**:
- 導出為單一 HTML 文件或資料夾結構
- 保留所有動畫與轉場效果
- 支援鍵盤導覽 (方向鍵、空白鍵)
- 包含演講者備註 (可選)
- 可嵌入於 iframe

---

### US-005: 批次導出
> **作為** 一位知識管理者
> **我希望** 能一次選擇多個筆記進行批次導出
> **以便** 快速生成整個知識庫的備份

**驗收條件**:
- 支援多選筆記/資料夾
- 顯示導出進度條
- 導出完成後顯示摘要報告
- 支援中斷/取消操作

---

### US-006: 主題模板選擇
> **作為** 一位品牌設計師
> **我希望** 能從多種預設主題中選擇導出樣式
> **以便** 導出的內容符合公司品牌形象

**驗收條件**:
- 提供至少 5 種內建主題
- 主題預覽功能
- 可自訂主色調與字型
- 支援匯入自訂 CSS

---

### US-007: 資源最佳化選項
> **作為** 一位需要分享大型文檔的用戶
> **我希望** 能在導出時選擇圖片壓縮等級
> **以便** 平衡檔案大小與品質

**驗收條件**:
- 提供圖片品質選項 (高/中/低)
- 顯示預估檔案大小
- 可選擇嵌入或外連資源
- 支援延遲載入圖片

---

### US-008: 導出歷史與快取
> **作為** 一位頻繁導出的用戶
> **我希望** 系統能記住我的導出設定
> **以便** 下次導出時無需重複配置

**驗收條件**:
- 儲存最近 10 次導出配置
- 可將配置存為預設
- 快取已處理的資源以加速重複導出
- 支援清除快取功能

---

## 3. 導出格式規格

### 3.1 HTML 單頁導出

#### 3.1.1 輸出結構

```
output/
└── my-note.html          # 自包含 HTML 文件
```

#### 3.1.2 HTML 結構

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="ShotBoard Export v1.0">
  <title>{文檔標題}</title>
  <style>
    /* 內嵌的完整 CSS 樣式 */
    {theme_css}
    {prism_css}
    {custom_css}
  </style>
</head>
<body>
  <article class="shotboard-content">
    <header class="document-header">
      <h1>{標題}</h1>
      <div class="meta">
        <time datetime="{ISO日期}">{格式化日期}</time>
        <span class="tags">{標籤列表}</span>
      </div>
    </header>

    <nav class="table-of-contents">
      <!-- 自動生成的目錄 -->
    </nav>

    <main class="document-body">
      {渲染後的 HTML 內容}
    </main>

    <footer class="document-footer">
      <p>Generated by ShotBoard</p>
    </footer>
  </article>

  <script>
    // 內嵌的互動腳本 (目錄高亮、程式碼複製等)
  </script>
</body>
</html>
```

#### 3.1.3 資源處理策略

| 資源類型 | 處理方式 | 備註 |
|----------|----------|------|
| 圖片 < 100KB | Base64 內嵌 | `data:image/png;base64,...` |
| 圖片 >= 100KB | 外部文件 | 隨附 `assets/` 資料夾 |
| 白板繪圖 | SVG 內嵌 | 保留互動性 (可選) |
| 程式碼區塊 | Prism.js 高亮 | CSS 內嵌 |
| 數學公式 | KaTeX 渲染 | SVG 或 HTML |

---

### 3.2 多頁靜態網站

#### 3.2.1 輸出結構

```
output/
├── index.html                    # 首頁
├── 404.html                      # 404 頁面
├── assets/
│   ├── css/
│   │   ├── main.css              # 主樣式
│   │   ├── prism.css             # 程式碼高亮
│   │   └── theme.css             # 主題樣式
│   ├── js/
│   │   ├── main.js               # 主腳本
│   │   ├── search.js             # 搜索功能
│   │   └── navigation.js         # 導覽邏輯
│   ├── images/                   # 圖片資源
│   │   ├── img_001.png
│   │   └── ...
│   └── fonts/                    # 字型 (可選)
├── chapter-01/
│   ├── index.html                # 章節首頁
│   ├── lesson-01.html
│   └── lesson-02.html
├── chapter-02/
│   └── ...
├── search-index.json             # 搜索索引
└── sitemap.xml                   # Sitemap (可選)
```

#### 3.2.2 導覽結構

```html
<!-- 側邊欄導覽 -->
<nav class="sidebar">
  <div class="site-title">
    <a href="/">{網站標題}</a>
  </div>

  <ul class="nav-list">
    <li class="nav-item">
      <a href="/chapter-01/">Chapter 01</a>
      <ul class="nav-children">
        <li><a href="/chapter-01/lesson-01.html">Lesson 01</a></li>
        <li><a href="/chapter-01/lesson-02.html">Lesson 02</a></li>
      </ul>
    </li>
    <!-- ... -->
  </ul>
</nav>
```

#### 3.2.3 搜索功能

採用 client-side 搜索，使用 Fuse.js 或 Lunr.js：

```json
// search-index.json
{
  "version": "1.0",
  "documents": [
    {
      "id": "chapter-01/lesson-01",
      "title": "Lesson 01 - Introduction",
      "content": "純文字內容...",
      "headings": ["標題1", "標題2"],
      "tags": ["tag1", "tag2"]
    }
  ]
}
```

---

### 3.3 PDF 導出

#### 3.3.1 PDF 規格

| 屬性 | 預設值 | 可選項 |
|------|--------|--------|
| 紙張尺寸 | A4 | A4, Letter, A3, Custom |
| 方向 | Portrait | Portrait, Landscape |
| 邊距 | 20mm | 10-50mm |
| 頁首 | 文檔標題 | 自訂文字、日期、頁碼 |
| 頁尾 | 頁碼 | 自訂文字、日期、頁碼 |
| 字型 | Noto Sans TC | 系統字型或嵌入字型 |
| 圖片品質 | 150 DPI | 72-300 DPI |

#### 3.3.2 特殊處理

```typescript
interface PDFPageBreakRules {
  // 避免在這些元素前分頁
  avoidBreakBefore: ['h1', 'h2', 'h3'];

  // 避免在這些元素後分頁
  avoidBreakAfter: ['h1', 'h2', 'h3', 'h4'];

  // 保持這些元素不被拆分
  keepTogether: ['pre', 'table', 'figure', '.whiteboard-embed'];

  // 強制分頁標記
  forceBreak: ['hr.page-break', '.new-page'];
}
```

#### 3.3.3 目錄生成

```typescript
interface PDFTableOfContents {
  enabled: boolean;
  title: string;                    // "目錄"
  maxDepth: number;                 // 1-6
  includePageNumbers: boolean;
  dotLeader: boolean;               // 標題與頁碼間的點線
}
```

---

### 3.4 簡報獨立 HTML

#### 3.4.1 輸出結構 (單檔模式)

```
output/
└── presentation.html     # 自包含簡報文件
```

#### 3.4.2 輸出結構 (資料夾模式)

```
output/
├── index.html            # 簡報主文件
├── assets/
│   ├── reveal.js/        # 簡報引擎
│   ├── theme.css         # 簡報主題
│   └── images/           # 圖片資源
└── notes.html            # 演講者備註 (可選)
```

#### 3.4.3 簡報 HTML 結構

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>{簡報標題}</title>
  <link rel="stylesheet" href="assets/reveal.js/reveal.css">
  <link rel="stylesheet" href="assets/theme.css">
</head>
<body>
  <div class="reveal">
    <div class="slides">
      <section data-slide-index="0">
        <!-- 第一張投影片 -->
      </section>
      <section data-slide-index="1">
        <!-- 第二張投影片 -->
      </section>
    </div>
  </div>

  <script src="assets/reveal.js/reveal.js"></script>
  <script>
    Reveal.initialize({
      hash: true,
      controls: true,
      progress: true,
      center: true,
      transition: 'slide'
    });
  </script>
</body>
</html>
```

---

## 4. 功能需求 (Functional Requirements)

### 4.1 核心導出功能

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-001 | HTML 單頁導出 | 將單一 Markdown 筆記導出為自包含 HTML | P0 |
| FR-002 | 多頁網站導出 | 將資料夾結構導出為靜態網站 | P0 |
| FR-003 | PDF 導出 | 透過 Puppeteer 生成高品質 PDF | P0 |
| FR-004 | 簡報 HTML 導出 | 將 Slidev 格式導出為可播放簡報 | P1 |
| FR-005 | 批次導出 | 支援多選筆記批次導出 | P1 |
| FR-006 | 導出預覽 | 導出前預覽最終效果 | P1 |

### 4.2 模板與樣式

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-007 | 內建主題 | 提供至少 5 種預設主題 | P0 |
| FR-008 | 主題預覽 | 即時預覽主題效果 | P1 |
| FR-009 | 自訂 CSS | 支援用戶自訂 CSS 樣式 | P1 |
| FR-010 | 主色調設定 | 可調整主題主色調 | P2 |
| FR-011 | 字型設定 | 可選擇字型家族與大小 | P2 |

### 4.3 資源處理

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-012 | 圖片最佳化 | 壓縮圖片以減少檔案大小 | P0 |
| FR-013 | 白板 SVG 導出 | 將 Excalidraw 繪圖轉為 SVG | P0 |
| FR-014 | 資源路徑處理 | 正確處理相對/絕對路徑 | P0 |
| FR-015 | 延遲載入 | 大型資源支援 lazy loading | P2 |
| FR-016 | 資源快取 | 快取已處理資源加速重複導出 | P2 |

### 4.4 PDF 特有功能

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-017 | 紙張設定 | 支援多種紙張尺寸與方向 | P0 |
| FR-018 | 邊距設定 | 可調整頁面邊距 | P0 |
| FR-019 | 頁首頁尾 | 自訂頁首頁尾內容 | P1 |
| FR-020 | 自動目錄 | 生成可點擊的目錄頁 | P1 |
| FR-021 | 分頁控制 | 智慧分頁避免內容截斷 | P1 |
| FR-022 | 浮水印 | 可添加浮水印 (可選) | P2 |

### 4.5 靜態網站特有功能

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-023 | 自動導覽 | 根據資料夾結構生成導覽 | P0 |
| FR-024 | 搜索功能 | Client-side 全文搜索 | P1 |
| FR-025 | 麵包屑導覽 | 顯示當前頁面路徑 | P1 |
| FR-026 | 上下頁連結 | 頁面底部的上下頁導覽 | P1 |
| FR-027 | Sitemap 生成 | 生成 sitemap.xml | P2 |
| FR-028 | SEO Meta | 生成適當的 meta 標籤 | P2 |

### 4.6 用戶體驗

| ID | 功能 | 描述 | 優先級 |
|----|------|------|--------|
| FR-029 | 導出對話框 | 統一的導出設定 UI | P0 |
| FR-030 | 進度顯示 | 顯示導出進度與狀態 | P0 |
| FR-031 | 錯誤處理 | 友善的錯誤訊息與恢復選項 | P0 |
| FR-032 | 設定儲存 | 記住用戶的導出偏好 | P1 |
| FR-033 | 快速導出 | 一鍵使用預設設定導出 | P1 |
| FR-034 | 導出歷史 | 查看過去的導出記錄 | P2 |

---

## 5. 數據模型 (Data Models)

### 5.1 核心類型定義

```typescript
// src/types/export.ts

/**
 * 導出格式枚舉
 */
export type ExportFormat = 'html-single' | 'html-site' | 'pdf' | 'slides';

/**
 * 圖片品質等級
 */
export type ImageQuality = 'high' | 'medium' | 'low';

/**
 * 紙張尺寸
 */
export type PaperSize = 'a4' | 'letter' | 'a3' | 'legal' | 'custom';

/**
 * 頁面方向
 */
export type PageOrientation = 'portrait' | 'landscape';

/**
 * 導出狀態
 */
export type ExportStatus = 'idle' | 'preparing' | 'processing' | 'completed' | 'error';

/**
 * 主題類型
 */
export interface ExportTheme {
  id: string;
  name: string;
  description: string;
  previewImage: string;
  cssPath: string;
  variables: ThemeVariables;
}

/**
 * 主題變數
 */
export interface ThemeVariables {
  primaryColor: string;
  backgroundColor: string;
  textColor: string;
  fontFamily: string;
  fontSize: string;
  lineHeight: string;
  codeFont: string;
  borderRadius: string;
}
```

### 5.2 導出配置

```typescript
/**
 * 基礎導出配置
 */
export interface BaseExportConfig {
  /** 導出格式 */
  format: ExportFormat;

  /** 輸出目錄路徑 */
  outputPath: string;

  /** 選擇的主題 */
  theme: ExportTheme;

  /** 自訂 CSS */
  customCSS?: string;

  /** 是否生成目錄 */
  generateTOC: boolean;

  /** 目錄最大深度 (1-6) */
  tocDepth: number;

  /** 圖片品質 */
  imageQuality: ImageQuality;

  /** 是否壓縮輸出 */
  minify: boolean;

  /** 是否包含 ShotBoard 版權資訊 */
  includeBranding: boolean;
}

/**
 * HTML 單頁導出配置
 */
export interface HTMLSingleExportConfig extends BaseExportConfig {
  format: 'html-single';

  /** 是否內嵌所有資源 (Base64) */
  embedResources: boolean;

  /** 內嵌資源的大小閾值 (bytes) */
  embedThreshold: number;

  /** 是否內嵌 CSS */
  inlineCSS: boolean;

  /** 是否內嵌 JavaScript */
  inlineJS: boolean;
}

/**
 * 靜態網站導出配置
 */
export interface HTMLSiteExportConfig extends BaseExportConfig {
  format: 'html-site';

  /** 網站標題 */
  siteTitle: string;

  /** 網站描述 */
  siteDescription?: string;

  /** 網站 Logo */
  siteLogo?: string;

  /** Base URL (用於部署至子目錄) */
  baseUrl: string;

  /** 是否生成搜索功能 */
  enableSearch: boolean;

  /** 是否生成 Sitemap */
  generateSitemap: boolean;

  /** 是否生成 404 頁面 */
  generate404: boolean;

  /** 導覽配置 */
  navigation: NavigationConfig;

  /** 頁尾配置 */
  footer?: FooterConfig;
}

/**
 * PDF 導出配置
 */
export interface PDFExportConfig extends BaseExportConfig {
  format: 'pdf';

  /** 紙張尺寸 */
  paperSize: PaperSize;

  /** 自訂紙張尺寸 (mm) */
  customSize?: { width: number; height: number };

  /** 頁面方向 */
  orientation: PageOrientation;

  /** 邊距 (mm) */
  margins: {
    top: number;
    right: number;
    bottom: number;
    left: number;
  };

  /** 頁首配置 */
  header?: PageHeaderFooter;

  /** 頁尾配置 */
  footer?: PageHeaderFooter;

  /** 是否生成目錄頁 */
  generateTOCPage: boolean;

  /** 是否顯示頁碼 */
  showPageNumbers: boolean;

  /** 圖片 DPI */
  imageDPI: number;

  /** 浮水印配置 */
  watermark?: WatermarkConfig;
}

/**
 * 簡報導出配置
 */
export interface SlidesExportConfig extends BaseExportConfig {
  format: 'slides';

  /** 是否打包為單一文件 */
  singleFile: boolean;

  /** 簡報引擎 */
  engine: 'reveal' | 'impress';

  /** 轉場效果 */
  transition: 'none' | 'fade' | 'slide' | 'convex' | 'concave' | 'zoom';

  /** 是否包含演講者備註 */
  includeNotes: boolean;

  /** 是否包含控制元件 */
  showControls: boolean;

  /** 是否顯示進度條 */
  showProgress: boolean;

  /** 是否支援觸控滑動 */
  touchNavigation: boolean;

  /** 簡報比例 */
  aspectRatio: '16:9' | '4:3' | '16:10';
}

/**
 * 統一導出配置類型
 */
export type ExportConfig =
  | HTMLSingleExportConfig
  | HTMLSiteExportConfig
  | PDFExportConfig
  | SlidesExportConfig;
```

### 5.3 輔助類型

```typescript
/**
 * 導覽配置
 */
export interface NavigationConfig {
  /** 導覽類型 */
  type: 'auto' | 'manual';

  /** 手動配置的導覽項目 */
  items?: NavigationItem[];

  /** 是否顯示麵包屑 */
  showBreadcrumb: boolean;

  /** 是否顯示上下頁連結 */
  showPrevNext: boolean;

  /** 側邊欄位置 */
  sidebarPosition: 'left' | 'right';

  /** 是否可收合側邊欄 */
  collapsibleSidebar: boolean;
}

/**
 * 導覽項目
 */
export interface NavigationItem {
  title: string;
  path: string;
  children?: NavigationItem[];
  icon?: string;
}

/**
 * 頁首/頁尾配置
 */
export interface PageHeaderFooter {
  /** 左側內容 */
  left?: string;

  /** 中間內容 */
  center?: string;

  /** 右側內容 */
  right?: string;

  /** 可用變數: {title}, {date}, {pageNumber}, {totalPages} */
}

/**
 * 頁尾配置 (網站)
 */
export interface FooterConfig {
  /** 版權文字 */
  copyright?: string;

  /** 連結 */
  links?: Array<{ text: string; url: string }>;

  /** 是否顯示 "Powered by ShotBoard" */
  showPoweredBy: boolean;
}

/**
 * 浮水印配置
 */
export interface WatermarkConfig {
  /** 浮水印文字 */
  text: string;

  /** 字型大小 */
  fontSize: number;

  /** 顏色 (含透明度) */
  color: string;

  /** 旋轉角度 */
  rotation: number;

  /** 位置 */
  position: 'center' | 'diagonal' | 'corner';
}
```

### 5.4 導出結果與進度

```typescript
/**
 * 導出進度
 */
export interface ExportProgress {
  /** 當前狀態 */
  status: ExportStatus;

  /** 當前步驟描述 */
  currentStep: string;

  /** 進度百分比 (0-100) */
  percentage: number;

  /** 已處理項目數 */
  processedItems: number;

  /** 總項目數 */
  totalItems: number;

  /** 警告訊息 */
  warnings: string[];

  /** 錯誤訊息 */
  errors: string[];
}

/**
 * 導出結果
 */
export interface ExportResult {
  /** 是否成功 */
  success: boolean;

  /** 輸出路徑 */
  outputPath: string;

  /** 生成的文件列表 */
  files: ExportedFile[];

  /** 總檔案大小 (bytes) */
  totalSize: number;

  /** 導出耗時 (ms) */
  duration: number;

  /** 警告訊息 */
  warnings: string[];

  /** 錯誤訊息 (如果失敗) */
  error?: string;

  /** 統計資訊 */
  statistics: ExportStatistics;
}

/**
 * 導出的文件
 */
export interface ExportedFile {
  /** 相對路徑 */
  path: string;

  /** 文件類型 */
  type: 'html' | 'css' | 'js' | 'image' | 'font' | 'other';

  /** 文件大小 (bytes) */
  size: number;
}

/**
 * 導出統計
 */
export interface ExportStatistics {
  /** 頁面數量 */
  pageCount: number;

  /** 圖片數量 */
  imageCount: number;

  /** 白板數量 */
  whiteboardCount: number;

  /** 程式碼區塊數量 */
  codeBlockCount: number;

  /** 原始大小 */
  originalSize: number;

  /** 壓縮後大小 */
  compressedSize: number;
}
```

### 5.5 模板定義

```typescript
/**
 * HTML 模板
 */
export interface HTMLTemplate {
  /** 模板 ID */
  id: string;

  /** 模板名稱 */
  name: string;

  /** 模板類型 */
  type: 'single-page' | 'site-page' | 'site-layout';

  /** Handlebars 模板內容 */
  content: string;

  /** 所需的 partial 模板 */
  partials?: Record<string, string>;

  /** 預設樣式 */
  defaultStyles: string;
}

/**
 * PDF 模板
 */
export interface PDFTemplate extends HTMLTemplate {
  type: 'pdf-page';

  /** 頁首模板 */
  headerTemplate?: string;

  /** 頁尾模板 */
  footerTemplate?: string;

  /** 目錄頁模板 */
  tocTemplate?: string;
}

/**
 * 簡報模板
 */
export interface SlideTemplate {
  /** 模板 ID */
  id: string;

  /** 模板名稱 */
  name: string;

  /** 佈局類型 */
  layout: 'default' | 'title' | 'two-column' | 'image-right' | 'image-left' | 'image-full';

  /** HTML 結構 */
  structure: string;

  /** 樣式 */
  styles: string;
}
```

---

## 6. API 設計

### 6.1 導出服務 API

```typescript
// src/services/ExportService.ts

import { EventEmitter } from 'events';
import type {
  ExportConfig,
  ExportProgress,
  ExportResult,
  ExportTheme,
} from '../types/export';
import type { MarkdownNote } from '../types/note';

/**
 * 導出服務類別
 */
export class ExportService extends EventEmitter {
  private currentExport: AbortController | null = null;

  /**
   * 執行導出
   * @param notes - 要導出的筆記
   * @param config - 導出配置
   * @returns 導出結果
   */
  async export(
    notes: MarkdownNote[],
    config: ExportConfig
  ): Promise<ExportResult> {
    // 實作詳見第 10 節
  }

  /**
   * 取消當前導出
   */
  cancel(): void {
    if (this.currentExport) {
      this.currentExport.abort();
      this.currentExport = null;
    }
  }

  /**
   * 預覽導出結果
   * @param note - 單一筆記
   * @param config - 導出配置
   * @returns 預覽 HTML
   */
  async preview(
    note: MarkdownNote,
    config: ExportConfig
  ): Promise<string> {
    // 生成預覽 HTML
  }

  /**
   * 取得可用主題列表
   */
  getAvailableThemes(): ExportTheme[] {
    // 返回內建主題
  }

  /**
   * 載入自訂主題
   * @param cssPath - CSS 文件路徑
   */
  async loadCustomTheme(cssPath: string): Promise<ExportTheme> {
    // 解析並載入自訂主題
  }

  /**
   * 估算導出大小
   * @param notes - 要導出的筆記
   * @param config - 導出配置
   */
  async estimateSize(
    notes: MarkdownNote[],
    config: ExportConfig
  ): Promise<{ estimated: number; breakdown: Record<string, number> }> {
    // 估算檔案大小
  }

  // 事件: 'progress' | 'warning' | 'error' | 'complete'
}
```

### 6.2 Markdown 處理 API

```typescript
// src/utils/export/markdownProcessor.ts

import type { MarkdownNote } from '../types/note';

export interface ProcessedMarkdown {
  /** 渲染後的 HTML */
  html: string;

  /** 提取的標題結構 (用於目錄) */
  headings: Heading[];

  /** 嵌入的資源 */
  embeddedResources: EmbeddedResource[];

  /** Front Matter 數據 */
  frontMatter: Record<string, unknown>;
}

export interface Heading {
  level: number;
  text: string;
  id: string;
  children: Heading[];
}

export interface EmbeddedResource {
  type: 'image' | 'whiteboard' | 'video' | 'file';
  originalPath: string;
  processedPath: string;
  size: number;
  mimeType: string;
}

/**
 * 處理 Markdown 內容
 */
export async function processMarkdown(
  note: MarkdownNote,
  options: ProcessOptions
): Promise<ProcessedMarkdown> {
  // 1. 解析 Front Matter
  // 2. 處理 Markdown 語法
  // 3. 處理自訂擴展 (白板嵌入等)
  // 4. 提取標題結構
  // 5. 處理嵌入資源
  // 6. 渲染為 HTML
}

export interface ProcessOptions {
  /** 是否處理數學公式 */
  enableMath: boolean;

  /** 是否處理程式碼高亮 */
  enableCodeHighlight: boolean;

  /** 程式碼高亮主題 */
  codeTheme: string;

  /** 是否處理白板嵌入 */
  enableWhiteboard: boolean;

  /** 基礎路徑 (用於資源路徑處理) */
  basePath: string;
}
```

### 6.3 資源處理 API

```typescript
// src/utils/export/resourceProcessor.ts

export interface ResourceProcessorOptions {
  /** 輸出目錄 */
  outputDir: string;

  /** 圖片品質 */
  imageQuality: ImageQuality;

  /** 是否壓縮 */
  compress: boolean;

  /** 內嵌大小閾值 (bytes) */
  embedThreshold: number;
}

export interface ProcessedResource {
  /** 原始路徑 */
  originalPath: string;

  /** 輸出路徑 (相對於 outputDir) */
  outputPath: string;

  /** 是否內嵌 (Base64) */
  embedded: boolean;

  /** 內嵌數據 (如果 embedded = true) */
  dataUri?: string;

  /** 文件大小 */
  size: number;
}

/**
 * 資源處理器
 */
export class ResourceProcessor {
  constructor(options: ResourceProcessorOptions) {}

  /**
   * 處理圖片
   */
  async processImage(imagePath: string): Promise<ProcessedResource> {}

  /**
   * 處理白板繪圖
   */
  async processWhiteboard(
    whiteboardId: string
  ): Promise<ProcessedResource> {}

  /**
   * 處理影片 (僅複製，不轉碼)
   */
  async processVideo(videoPath: string): Promise<ProcessedResource> {}

  /**
   * 批次處理資源
   */
  async processAll(
    resources: string[]
  ): Promise<Map<string, ProcessedResource>> {}
}
```

### 6.4 PDF 生成 API

```typescript
// src/utils/export/pdfGenerator.ts

import type { PDFExportConfig } from '../types/export';

export interface PDFGeneratorOptions extends PDFExportConfig {
  /** HTML 內容 */
  htmlContent: string;

  /** 輸出路徑 */
  outputPath: string;
}

/**
 * PDF 生成器 (Electron 專用)
 */
export class PDFGenerator {
  /**
   * 生成 PDF
   */
  async generate(options: PDFGeneratorOptions): Promise<{
    path: string;
    size: number;
    pageCount: number;
  }> {
    // 使用 Puppeteer / Electron printToPDF
  }

  /**
   * 生成帶目錄的 PDF
   */
  async generateWithTOC(
    chapters: Array<{ title: string; html: string }>,
    options: PDFGeneratorOptions
  ): Promise<{
    path: string;
    size: number;
    pageCount: number;
  }> {}
}
```

### 6.5 IPC 通訊 API (Electron)

```typescript
// electron/ipc/exportHandlers.ts

import { ipcMain, dialog, BrowserWindow } from 'electron';
import { ExportService } from '../../src/services/ExportService';

/**
 * 註冊導出相關的 IPC handlers
 */
export function registerExportHandlers(): void {
  const exportService = new ExportService();

  // 選擇導出目錄
  ipcMain.handle('export:selectOutputDir', async () => {
    const result = await dialog.showOpenDialog({
      properties: ['openDirectory', 'createDirectory'],
      title: '選擇導出目錄',
    });
    return result.canceled ? null : result.filePaths[0];
  });

  // 執行導出
  ipcMain.handle('export:execute', async (event, notes, config) => {
    const window = BrowserWindow.fromWebContents(event.sender);

    exportService.on('progress', (progress) => {
      window?.webContents.send('export:progress', progress);
    });

    return await exportService.export(notes, config);
  });

  // 取消導出
  ipcMain.handle('export:cancel', () => {
    exportService.cancel();
  });

  // 預覽
  ipcMain.handle('export:preview', async (event, note, config) => {
    return await exportService.preview(note, config);
  });

  // 開啟導出目錄
  ipcMain.handle('export:openOutputDir', async (event, path) => {
    const { shell } = require('electron');
    await shell.openPath(path);
  });
}
```

---

## 7. 模板系統

### 7.1 模板引擎

使用 Handlebars 作為模板引擎，提供以下特性：
- 條件判斷 (`{{#if}}`)
- 迴圈 (`{{#each}}`)
- Partial 模板 (`{{> partialName}}`)
- Helper 函數

### 7.2 內建 HTML 模板

#### 7.2.1 單頁模板 (single-page.hbs)

```handlebars
<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="ShotBoard Export v{{version}}">
  <meta name="description" content="{{description}}">
  <title>{{title}}</title>

  {{#if inlineCSS}}
  <style>
    {{{styles}}}
  </style>
  {{else}}
  <link rel="stylesheet" href="{{cssPath}}">
  {{/if}}
</head>
<body class="shotboard-document theme-{{theme.id}}">
  <article class="document-container">
    {{> documentHeader}}

    {{#if showTOC}}
    <nav class="table-of-contents" aria-label="目錄">
      <h2>目錄</h2>
      {{> tocList headings}}
    </nav>
    {{/if}}

    <main class="document-content">
      {{{content}}}
    </main>

    {{> documentFooter}}
  </article>

  {{#if inlineJS}}
  <script>
    {{{scripts}}}
  </script>
  {{else}}
  <script src="{{jsPath}}"></script>
  {{/if}}
</body>
</html>
```

#### 7.2.2 網站佈局模板 (site-layout.hbs)

```handlebars
<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{pageTitle}} | {{siteTitle}}</title>
  <link rel="stylesheet" href="{{baseUrl}}/assets/css/main.css">
  <link rel="stylesheet" href="{{baseUrl}}/assets/css/theme.css">
  {{#if enableSearch}}
  <link rel="stylesheet" href="{{baseUrl}}/assets/css/search.css">
  {{/if}}
</head>
<body class="shotboard-site theme-{{theme.id}}">
  <div class="site-wrapper">
    <!-- 頂部導覽 -->
    <header class="site-header">
      <div class="header-content">
        {{#if siteLogo}}
        <img src="{{siteLogo}}" alt="{{siteTitle}}" class="site-logo">
        {{/if}}
        <a href="{{baseUrl}}/" class="site-title">{{siteTitle}}</a>

        {{#if enableSearch}}
        <div class="search-container">
          <input type="search" id="search-input" placeholder="搜索...">
          <div id="search-results"></div>
        </div>
        {{/if}}
      </div>
    </header>

    <div class="main-container">
      <!-- 側邊欄 -->
      <aside class="sidebar {{navigation.sidebarPosition}}">
        <nav class="sidebar-nav" aria-label="主導覽">
          {{> navigationTree navigation.items}}
        </nav>
      </aside>

      <!-- 主內容區 -->
      <main class="main-content">
        {{#if navigation.showBreadcrumb}}
        <nav class="breadcrumb" aria-label="麵包屑">
          {{> breadcrumb breadcrumbItems}}
        </nav>
        {{/if}}

        <article class="page-content">
          {{{content}}}
        </article>

        {{#if navigation.showPrevNext}}
        <nav class="prev-next-nav">
          {{#if prevPage}}
          <a href="{{prevPage.url}}" class="prev-link">
            <span class="nav-label">上一頁</span>
            <span class="nav-title">{{prevPage.title}}</span>
          </a>
          {{/if}}
          {{#if nextPage}}
          <a href="{{nextPage.url}}" class="next-link">
            <span class="nav-label">下一頁</span>
            <span class="nav-title">{{nextPage.title}}</span>
          </a>
          {{/if}}
        </nav>
        {{/if}}
      </main>

      <!-- 右側目錄 -->
      <aside class="toc-sidebar">
        <nav class="page-toc" aria-label="頁面目錄">
          <h3>本頁目錄</h3>
          {{> tocList pageHeadings}}
        </nav>
      </aside>
    </div>

    <!-- 頁尾 -->
    <footer class="site-footer">
      {{#if footer.copyright}}
      <p class="copyright">{{footer.copyright}}</p>
      {{/if}}
      {{#if footer.links}}
      <nav class="footer-links">
        {{#each footer.links}}
        <a href="{{this.url}}">{{this.text}}</a>
        {{/each}}
      </nav>
      {{/if}}
      {{#if footer.showPoweredBy}}
      <p class="powered-by">Powered by ShotBoard</p>
      {{/if}}
    </footer>
  </div>

  <script src="{{baseUrl}}/assets/js/main.js"></script>
  {{#if enableSearch}}
  <script src="{{baseUrl}}/assets/js/search.js"></script>
  {{/if}}
</body>
</html>
```

### 7.3 PDF 模板

#### 7.3.1 PDF 頁面模板 (pdf-page.hbs)

```handlebars
<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <title>{{title}}</title>
  <style>
    @page {
      size: {{paperSize}} {{orientation}};
      margin: {{margins.top}}mm {{margins.right}}mm {{margins.bottom}}mm {{margins.left}}mm;

      @top-left {
        content: "{{header.left}}";
      }
      @top-center {
        content: "{{header.center}}";
      }
      @top-right {
        content: "{{header.right}}";
      }
      @bottom-left {
        content: "{{footer.left}}";
      }
      @bottom-center {
        content: "{{footer.center}}";
      }
      @bottom-right {
        content: "{{footer.right}}";
      }
    }

    {{{pdfStyles}}}
  </style>
</head>
<body class="pdf-document">
  {{#if generateTOCPage}}
  <section class="toc-page">
    <h1>目錄</h1>
    {{> pdfTocList headings}}
  </section>
  {{/if}}

  <article class="pdf-content">
    {{{content}}}
  </article>
</body>
</html>
```

#### 7.3.2 PDF 頁首模板 (pdf-header.hbs)

```handlebars
<div class="pdf-header" style="font-size: 10px; color: #666;">
  <span class="header-left">{{left}}</span>
  <span class="header-center">{{center}}</span>
  <span class="header-right">{{right}}</span>
</div>
```

#### 7.3.3 PDF 頁尾模板 (pdf-footer.hbs)

```handlebars
<div class="pdf-footer" style="font-size: 10px; color: #666; text-align: center;">
  {{#if showPageNumbers}}
  <span class="page-number">第 <span class="pageNumber"></span> 頁，共 <span class="totalPages"></span> 頁</span>
  {{/if}}
</div>
```

### 7.4 內建主題

| 主題 ID | 名稱 | 描述 | 適用場景 |
|---------|------|------|----------|
| `default` | 預設 | 簡潔明亮的預設主題 | 通用 |
| `dark` | 暗色 | 深色背景，護眼 | 技術文檔 |
| `academic` | 學術 | 正式的學術論文風格 | 報告、論文 |
| `minimal` | 極簡 | 無裝飾的純文字風格 | 閱讀專注 |
| `corporate` | 企業 | 專業商務風格 | 企業報告 |

---

## 8. 資源處理

### 8.1 圖片處理

```typescript
// src/utils/export/imageProcessor.ts

import sharp from 'sharp';

export interface ImageProcessOptions {
  /** 最大寬度 */
  maxWidth: number;

  /** 最大高度 */
  maxHeight: number;

  /** 品質 (1-100) */
  quality: number;

  /** 輸出格式 */
  format: 'jpeg' | 'png' | 'webp';

  /** 是否保留 EXIF */
  preserveExif: boolean;
}

const qualityPresets: Record<ImageQuality, ImageProcessOptions> = {
  high: {
    maxWidth: 2400,
    maxHeight: 2400,
    quality: 90,
    format: 'png',
    preserveExif: true,
  },
  medium: {
    maxWidth: 1600,
    maxHeight: 1600,
    quality: 80,
    format: 'jpeg',
    preserveExif: false,
  },
  low: {
    maxWidth: 1200,
    maxHeight: 1200,
    quality: 60,
    format: 'jpeg',
    preserveExif: false,
  },
};

export async function processImage(
  inputPath: string,
  outputPath: string,
  quality: ImageQuality
): Promise<{ size: number; dimensions: { width: number; height: number } }> {
  const options = qualityPresets[quality];

  const result = await sharp(inputPath)
    .resize(options.maxWidth, options.maxHeight, {
      fit: 'inside',
      withoutEnlargement: true,
    })
    .toFormat(options.format, { quality: options.quality })
    .toFile(outputPath);

  return {
    size: result.size,
    dimensions: { width: result.width, height: result.height },
  };
}
```

### 8.2 白板繪圖處理

```typescript
// src/utils/export/whiteboardProcessor.ts

import { exportToSvg, exportToBlob } from '@excalidraw/excalidraw';
import type { ExcalidrawElement } from '@excalidraw/excalidraw/types/element/types';

export interface WhiteboardExportOptions {
  /** 輸出格式 */
  format: 'svg' | 'png';

  /** 背景顏色 */
  backgroundColor: string;

  /** 是否包含深色模式適配 */
  darkModeCompatible: boolean;

  /** PNG 縮放比例 */
  scale: number;

  /** 邊距 */
  padding: number;
}

export async function exportWhiteboard(
  elements: ExcalidrawElement[],
  options: WhiteboardExportOptions
): Promise<{ data: string | Blob; width: number; height: number }> {
  if (options.format === 'svg') {
    const svg = await exportToSvg({
      elements,
      appState: {
        exportBackground: true,
        viewBackgroundColor: options.backgroundColor,
      },
      files: null,
    });

    return {
      data: svg.outerHTML,
      width: parseInt(svg.getAttribute('width') || '0'),
      height: parseInt(svg.getAttribute('height') || '0'),
    };
  } else {
    const blob = await exportToBlob({
      elements,
      appState: {
        exportBackground: true,
        viewBackgroundColor: options.backgroundColor,
      },
      files: null,
      getDimensions: () => ({ width: 1920, height: 1080, scale: options.scale }),
    });

    return {
      data: blob,
      width: 1920 * options.scale,
      height: 1080 * options.scale,
    };
  }
}
```

### 8.3 資源打包策略

```typescript
// src/utils/export/bundler.ts

export interface BundleStrategy {
  /** 策略名稱 */
  name: 'inline' | 'external' | 'hybrid';

  /** 內嵌大小閾值 (bytes) */
  inlineThreshold: number;

  /** 資源目錄名稱 */
  assetsDir: string;
}

export const bundleStrategies: Record<ExportFormat, BundleStrategy> = {
  'html-single': {
    name: 'hybrid',
    inlineThreshold: 100 * 1024, // 100KB
    assetsDir: 'assets',
  },
  'html-site': {
    name: 'external',
    inlineThreshold: 0,
    assetsDir: 'assets',
  },
  'pdf': {
    name: 'inline',
    inlineThreshold: Infinity,
    assetsDir: '',
  },
  'slides': {
    name: 'hybrid',
    inlineThreshold: 50 * 1024, // 50KB
    assetsDir: 'assets',
  },
};
```

---

## 9. 組件規格

### 9.1 ExportDialog 組件

```typescript
// src/components/Export/ExportDialog.tsx

import { useState, useCallback } from 'react';
import type { ExportConfig, ExportFormat, ExportTheme } from '../../types/export';
import type { MarkdownNote } from '../../types/note';

interface ExportDialogProps {
  /** 是否顯示對話框 */
  isOpen: boolean;

  /** 關閉對話框回調 */
  onClose: () => void;

  /** 要導出的筆記 */
  notes: MarkdownNote[];

  /** 導出完成回調 */
  onExportComplete: (result: ExportResult) => void;
}

interface ExportDialogState {
  /** 當前步驟 */
  step: 'format' | 'options' | 'preview' | 'exporting' | 'complete';

  /** 選擇的格式 */
  format: ExportFormat;

  /** 導出配置 */
  config: Partial<ExportConfig>;

  /** 導出進度 */
  progress: ExportProgress | null;

  /** 導出結果 */
  result: ExportResult | null;
}

export function ExportDialog({ isOpen, onClose, notes, onExportComplete }: ExportDialogProps) {
  // 組件實作
}
```

### 9.2 組件結構

```
src/components/Export/
├── ExportDialog.tsx          # 主對話框容器
├── ExportDialog.module.css   # 樣式
├── steps/
│   ├── FormatSelection.tsx   # 步驟 1: 格式選擇
│   ├── ExportOptions.tsx     # 步驟 2: 選項配置
│   ├── ExportPreview.tsx     # 步驟 3: 預覽
│   ├── ExportProgress.tsx    # 步驟 4: 導出進度
│   └── ExportComplete.tsx    # 步驟 5: 完成
├── options/
│   ├── HTMLSingleOptions.tsx # HTML 單頁選項
│   ├── HTMLSiteOptions.tsx   # 靜態網站選項
│   ├── PDFOptions.tsx        # PDF 選項
│   └── SlidesOptions.tsx     # 簡報選項
├── ThemeSelector.tsx         # 主題選擇器
├── ThemePreview.tsx          # 主題預覽
└── index.ts                  # 導出
```

### 9.3 FormatSelection 組件

```typescript
// src/components/Export/steps/FormatSelection.tsx

interface FormatSelectionProps {
  selectedFormat: ExportFormat | null;
  onSelect: (format: ExportFormat) => void;
  noteCount: number;
}

const formatOptions: Array<{
  id: ExportFormat;
  icon: string;
  title: string;
  description: string;
  singleNoteOnly?: boolean;
}> = [
  {
    id: 'html-single',
    icon: 'file-html',
    title: 'HTML 單頁',
    description: '導出為自包含的 HTML 文件，方便分享',
    singleNoteOnly: true,
  },
  {
    id: 'html-site',
    icon: 'globe',
    title: '靜態網站',
    description: '生成完整的靜態網站，含導覽與搜索',
  },
  {
    id: 'pdf',
    icon: 'file-pdf',
    title: 'PDF 文檔',
    description: '高品質 PDF，適合列印與正式分享',
  },
  {
    id: 'slides',
    icon: 'presentation',
    title: '簡報 HTML',
    description: '將 Slidev 格式導出為可播放簡報',
    singleNoteOnly: true,
  },
];
```

### 9.4 ExportProgress 組件

```typescript
// src/components/Export/steps/ExportProgress.tsx

interface ExportProgressProps {
  progress: ExportProgress;
  onCancel: () => void;
}

export function ExportProgress({ progress, onCancel }: ExportProgressProps) {
  return (
    <div className="export-progress">
      <div className="progress-header">
        <h3>正在導出...</h3>
        <button onClick={onCancel} className="cancel-button">
          取消
        </button>
      </div>

      <div className="progress-bar">
        <div
          className="progress-fill"
          style={{ width: `${progress.percentage}%` }}
        />
      </div>

      <div className="progress-info">
        <span className="current-step">{progress.currentStep}</span>
        <span className="item-count">
          {progress.processedItems} / {progress.totalItems}
        </span>
      </div>

      {progress.warnings.length > 0 && (
        <div className="warnings">
          <h4>警告</h4>
          <ul>
            {progress.warnings.map((warning, i) => (
              <li key={i}>{warning}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
```

---

## 10. Electron 整合

### 10.1 PDF 生成流程

```typescript
// electron/services/pdfService.ts

import { BrowserWindow } from 'electron';
import * as path from 'path';
import * as fs from 'fs/promises';
import type { PDFExportConfig } from '../../src/types/export';

interface PDFServiceOptions {
  /** 臨時文件目錄 */
  tempDir: string;
}

export class PDFService {
  private tempDir: string;

  constructor(options: PDFServiceOptions) {
    this.tempDir = options.tempDir;
  }

  /**
   * 生成 PDF
   */
  async generatePDF(
    htmlContent: string,
    config: PDFExportConfig,
    outputPath: string
  ): Promise<{ pageCount: number; size: number }> {
    // 1. 將 HTML 寫入臨時文件
    const tempHtmlPath = path.join(this.tempDir, `export_${Date.now()}.html`);
    await fs.writeFile(tempHtmlPath, htmlContent, 'utf-8');

    // 2. 創建隱藏的 BrowserWindow
    const win = new BrowserWindow({
      show: false,
      webPreferences: {
        nodeIntegration: false,
        contextIsolation: true,
      },
    });

    try {
      // 3. 載入 HTML
      await win.loadFile(tempHtmlPath);

      // 4. 等待頁面完全載入
      await win.webContents.executeJavaScript(`
        new Promise(resolve => {
          if (document.readyState === 'complete') {
            resolve();
          } else {
            window.addEventListener('load', resolve);
          }
        });
      `);

      // 5. 生成 PDF
      const pdfData = await win.webContents.printToPDF({
        marginsType: 0,
        pageSize: this.getPaperSize(config),
        landscape: config.orientation === 'landscape',
        printBackground: true,
        headerTemplate: config.header ? this.formatHeaderFooter(config.header) : '',
        footerTemplate: config.footer ? this.formatHeaderFooter(config.footer) : '',
        displayHeaderFooter: !!(config.header || config.footer),
        preferCSSPageSize: false,
      });

      // 6. 寫入文件
      await fs.writeFile(outputPath, pdfData);

      // 7. 獲取頁數 (通過解析 PDF)
      const pageCount = await this.getPDFPageCount(pdfData);

      return {
        pageCount,
        size: pdfData.length,
      };
    } finally {
      // 8. 清理
      win.destroy();
      await fs.unlink(tempHtmlPath).catch(() => {});
    }
  }

  private getPaperSize(config: PDFExportConfig): Electron.PrintToPDFOptions['pageSize'] {
    if (config.paperSize === 'custom' && config.customSize) {
      return {
        width: config.customSize.width * 1000, // 轉換為 microns
        height: config.customSize.height * 1000,
      };
    }
    return config.paperSize.toUpperCase() as 'A4' | 'Letter' | 'A3' | 'Legal';
  }

  private formatHeaderFooter(template: PageHeaderFooter): string {
    return `
      <div style="font-size: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px;">
        <span>${template.left || ''}</span>
        <span>${template.center || ''}</span>
        <span>${template.right || ''}</span>
      </div>
    `;
  }

  private async getPDFPageCount(pdfBuffer: Buffer): Promise<number> {
    // 簡易的頁數計算 (通過搜索 PDF 頁面標記)
    const content = pdfBuffer.toString('binary');
    const matches = content.match(/\/Type\s*\/Page[^s]/g);
    return matches ? matches.length : 1;
  }
}
```

### 10.2 IPC 通道定義

```typescript
// electron/preload/exportPreload.ts

import { contextBridge, ipcRenderer } from 'electron';

export const exportAPI = {
  /**
   * 選擇導出目錄
   */
  selectOutputDir: (): Promise<string | null> => {
    return ipcRenderer.invoke('export:selectOutputDir');
  },

  /**
   * 執行導出
   */
  execute: (
    notes: MarkdownNote[],
    config: ExportConfig
  ): Promise<ExportResult> => {
    return ipcRenderer.invoke('export:execute', notes, config);
  },

  /**
   * 取消導出
   */
  cancel: (): Promise<void> => {
    return ipcRenderer.invoke('export:cancel');
  },

  /**
   * 預覽導出
   */
  preview: (
    note: MarkdownNote,
    config: ExportConfig
  ): Promise<string> => {
    return ipcRenderer.invoke('export:preview', note, config);
  },

  /**
   * 開啟導出目錄
   */
  openOutputDir: (path: string): Promise<void> => {
    return ipcRenderer.invoke('export:openOutputDir', path);
  },

  /**
   * 監聽導出進度
   */
  onProgress: (callback: (progress: ExportProgress) => void): () => void => {
    const handler = (_event: any, progress: ExportProgress) => callback(progress);
    ipcRenderer.on('export:progress', handler);
    return () => ipcRenderer.off('export:progress', handler);
  },
};

contextBridge.exposeInMainWorld('exportAPI', exportAPI);
```

### 10.3 類型聲明

```typescript
// src/types/electron.d.ts

interface ExportAPI {
  selectOutputDir: () => Promise<string | null>;
  execute: (notes: MarkdownNote[], config: ExportConfig) => Promise<ExportResult>;
  cancel: () => Promise<void>;
  preview: (note: MarkdownNote, config: ExportConfig) => Promise<string>;
  openOutputDir: (path: string) => Promise<void>;
  onProgress: (callback: (progress: ExportProgress) => void) => () => void;
}

declare global {
  interface Window {
    exportAPI: ExportAPI;
  }
}
```

---

## 11. 輸出目錄結構

### 11.1 HTML 單頁導出

```
[output-dir]/
├── my-document.html          # 自包含 HTML (如果資源較小)
└── my-document/              # 資料夾模式 (如果資源較大)
    ├── index.html
    └── assets/
        ├── image_001.png
        └── image_002.png
```

### 11.2 靜態網站導出

```
[output-dir]/
├── index.html                # 首頁
├── 404.html                  # 404 頁面
├── favicon.ico               # 網站圖示
├── robots.txt                # 搜尋引擎指引
├── sitemap.xml               # Sitemap
├── assets/
│   ├── css/
│   │   ├── main.css          # 主樣式表
│   │   ├── theme.css         # 主題樣式
│   │   ├── prism.css         # 程式碼高亮
│   │   └── katex.css         # 數學公式 (如使用)
│   ├── js/
│   │   ├── main.js           # 主腳本
│   │   ├── search.js         # 搜索功能
│   │   └── navigation.js     # 導覽邏輯
│   ├── images/
│   │   ├── logo.png          # 網站 Logo
│   │   ├── img_001.png       # 內容圖片
│   │   └── ...
│   └── fonts/                # 字型 (如需要)
├── search-index.json         # 搜索索引
├── getting-started/          # 章節資料夾
│   ├── index.html            # 章節首頁
│   ├── introduction.html     # 子頁面
│   └── installation.html
├── guide/
│   ├── index.html
│   ├── basics.html
│   └── advanced.html
└── api/
    ├── index.html
    └── reference.html
```

### 11.3 PDF 導出

```
[output-dir]/
└── my-document.pdf           # 單一 PDF 文件
```

### 11.4 簡報導出

```
[output-dir]/
├── presentation.html         # 單檔模式
│
└── presentation/             # 資料夾模式
    ├── index.html            # 簡報主文件
    ├── speaker-notes.html    # 演講者備註 (可選)
    └── assets/
        ├── reveal.js/        # 簡報引擎
        ├── theme.css
        └── images/
```

---

## 12. 驗收標準 (Acceptance Criteria)

### AC-001: HTML 單頁導出

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| 基本導出 | 成功生成 HTML 文件 | 執行導出，檢查文件生成 |
| 離線可用 | 無網路環境下可正常開啟 | 斷網後用瀏覽器開啟 |
| 圖片顯示 | 所有圖片正確顯示 | 視覺檢查 |
| 白板顯示 | Excalidraw 繪圖正確渲染 | 視覺檢查 |
| 程式碼高亮 | 程式碼區塊有語法高亮 | 視覺檢查 |
| 目錄連結 | 點擊目錄可跳轉到對應章節 | 互動測試 |
| 跨瀏覽器 | Chrome、Firefox、Safari 均可正常顯示 | 多瀏覽器測試 |
| 響應式 | 手機螢幕可正常閱讀 | 調整視窗大小測試 |

### AC-002: 靜態網站導出

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| 目錄結構 | 生成正確的資料夾與文件結構 | 檢查文件系統 |
| 導覽功能 | 側邊欄導覽可正常點擊 | 互動測試 |
| 搜索功能 | 可搜索到頁面內容 | 輸入關鍵字測試 |
| 麵包屑 | 正確顯示當前頁面路徑 | 視覺檢查 |
| 上下頁 | 上下頁連結正確 | 互動測試 |
| 相對路徑 | 部署至子目錄時資源路徑正確 | 本地伺服器測試 |
| Sitemap | 生成有效的 sitemap.xml | XML 驗證 |

### AC-003: PDF 導出

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| PDF 生成 | 成功生成 PDF 文件 | 執行導出，檢查文件生成 |
| 頁面尺寸 | 符合設定的紙張尺寸 | PDF 閱讀器檢查 |
| 邊距正確 | 邊距符合設定值 | 視覺檢查/測量 |
| 圖片品質 | 圖片清晰度符合設定 DPI | 視覺檢查 |
| 目錄頁 | 目錄頁連結可點擊跳轉 | PDF 閱讀器測試 |
| 頁首頁尾 | 正確顯示設定的頁首頁尾 | 視覺檢查 |
| 不截斷 | 表格/程式碼不被頁面截斷 | 視覺檢查 |
| 浮水印 | 浮水印正確顯示 (如設定) | 視覺檢查 |

### AC-004: 簡報導出

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| 簡報生成 | 成功生成簡報 HTML | 執行導出，檢查文件生成 |
| 離線播放 | 無網路環境下可正常播放 | 斷網後開啟測試 |
| 鍵盤導覽 | 方向鍵可切換投影片 | 互動測試 |
| 轉場效果 | 轉場動畫正確播放 | 視覺檢查 |
| 白板嵌入 | 嵌入的白板正確顯示 | 視覺檢查 |
| 演講者備註 | 備註頁面可正常開啟 | 互動測試 |

### AC-005: 資源處理

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| 圖片壓縮 | 導出圖片大小符合品質設定 | 比較文件大小 |
| 白板 SVG | SVG 格式可縮放不失真 | 放大查看 |
| 延遲載入 | 大型資源使用 lazy loading | 開發者工具檢查 |
| 快取機制 | 重複導出時速度提升 | 計時比較 |

### AC-006: 用戶體驗

| 測試項目 | 驗收條件 | 測試方法 |
|----------|----------|----------|
| 進度顯示 | 進度條正確反映導出進度 | 導出大量內容時觀察 |
| 可取消 | 點擊取消可中斷導出 | 互動測試 |
| 錯誤訊息 | 失敗時顯示友善錯誤訊息 | 製造錯誤情境 |
| 設定記憶 | 重新開啟對話框保留上次設定 | 關閉後重開測試 |

---

## 附錄 A: 技術依賴

```json
{
  "dependencies": {
    "unified": "^11.x",
    "remark-parse": "^11.x",
    "remark-gfm": "^4.x",
    "remark-math": "^6.x",
    "rehype-stringify": "^10.x",
    "rehype-prism-plus": "^2.x",
    "rehype-katex": "^7.x",
    "handlebars": "^4.x",
    "sharp": "^0.33.x",
    "fuse.js": "^7.x",
    "gray-matter": "^4.x"
  },
  "devDependencies": {
    "@types/handlebars": "^4.x"
  }
}
```

## 附錄 B: 錯誤代碼

| 代碼 | 描述 | 處理方式 |
|------|------|----------|
| `EXPORT_001` | 輸出目錄不存在或無寫入權限 | 提示用戶選擇有效目錄 |
| `EXPORT_002` | 資源文件遺失 | 列出遺失文件，詢問是否繼續 |
| `EXPORT_003` | PDF 生成失敗 | 顯示具體錯誤，提供重試選項 |
| `EXPORT_004` | 圖片處理失敗 | 使用原圖或跳過 |
| `EXPORT_005` | 白板導出失敗 | 使用佔位圖或跳過 |
| `EXPORT_006` | 模板渲染錯誤 | 顯示模板錯誤位置 |
| `EXPORT_007` | 磁碟空間不足 | 提示釋放空間或選擇其他目錄 |
| `EXPORT_008` | 導出已取消 | 清理部分生成的文件 |

## 附錄 C: 變更記錄

| 版本 | 日期 | 變更內容 |
|------|------|----------|
| 1.0.0 | 2025-01-XX | 初始版本 |

---

*文檔結束*
